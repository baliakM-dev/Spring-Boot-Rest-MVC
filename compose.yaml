services:
  db:
    image: mysql:8.1
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: restdb
      MYSQL_USER: restadmin
      MYSQL_PASSWORD: password
    ports:
      - "3306:3306"

  phpmyadmin:
    image: phpmyadmin
    depends_on:
      - db
    environment:
      PMA_HOST: db
    ports:
      - "8081:80"

  beer-store:
    build:
      context: ./beer-store
    depends_on:
      - db
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=localmysql
      - SPRING_DATASOURCE_URL=jdbc:mysql://db:3306/restdb
      - SPRING_DATASOURCE_USERNAME=restadmin
      - SPRING_DATASOURCE_PASSWORD=password
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=com.mysql.cj.jdbc.Driver
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/actuator/health" ]
      interval: 5s
      timeout: 3s
      retries: 20

  beer-client-resttemplate:
    build:
      context: ./beer-client-resttemplate
    ports:
      - "8082:8082"
    environment:
      - BEER_API_BASE_URL=http://beer-store:8080
    depends_on:
      beer-store:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8082/actuator/health" ]
      interval: 5s
      timeout: 3s
      retries: 20

  beer-client-restclient:
    build:
      context: ./beer-client-restclient
    ports:
      - "8083:8083"
    environment:
      - BEER_API_BASE_URL=http://beer-store:8080
    depends_on:
      beer-store:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8083/actuator/health" ]
      interval: 5s
      timeout: 3s
      retries: 20